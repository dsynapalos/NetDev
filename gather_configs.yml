---
- hosts: ALL_OS
  become: yes
  become_method: enable
  connection: network_cli
  gather_facts: yes
  
  vars:
  
    - become_pass: "{{ IOS_PASS }}"
    - ansible_user: "{{ IOS_USER }}"
    - ansible_password: "{{ IOS_PASS }}"
    - ansible_ssh_port: "{{ CSR1000V_SSH }}"
    - config_folder: /tmp/configs
  
  tasks:
    - debug: msg={{ ansible_facts }}
  
    - name: Setup default git configuration
      git_config:
        name: "{{ item.name }}"
        scope: global
        value: "{{ item.value }}"
      with_items:
        - {name: "user.name",  value: "{{ DOCKER_USERNAME }}" }
        - {name: "user.email", value: "{{ DOCKER_USERNAME }}@gmail.com" }
    
    - name: clone GitLab Project
      git:
        repo: "https://oauth2:{{ GITLAB_TOKEN | urlencode }}@gitlab.com/{{ DOCKER_USERNAME }}/configs_inv.git"
        dest: "{{ config_folder }}"
    
    - name: Enforce inventory
      lineinfile:
        path: "{{ config_folder }}/ansible_managed_inventory"
        regexp: '^[all_hosts:children]$'
        line: '[all_hosts:children]'
        create: yes
    
    - name: Conform networking type group
      lineinfile:
        path: "{{ config_folder }}/ansible_managed_inventory"
        regexp: '^{{ ansible_facts.net_model }}$'
        insertafter: '[all_hosts:children]'
        line: '{{ ansible_facts.net_model }}'
        
    - name: Conform networking type object
      lineinfile:
        path: "{{ config_folder }}/ansible_managed_inventory"
        regexp: '^[{{ ansible_facts.net_model }}]$'
        insertafter: '{{ ansible_facts.net_model }}'
        line: '[{{ ansible_facts.net_model }}]'
        
    - name: Update inventory
      lineinfile:
        path: "{{ config_folder }}/ansible_managed_inventory"
        regexp: '^{{ ansible_facts.net_hostname }}.*$'
        insertafter: '[{{ ansible_facts.net_model }}]'
        line: '{{ ansible_facts.net_hostname }} ansible_host={{ ansible_host }} ansible_ssh_port={{ ansible_ssh_port }}'
        
    - name: configurable backup path
      ios_config:
        backup: yes
        backup_options:
          filename: "{{ net_hostname }}"
          dir_path: "{{ config_folder }}/{{ net_model }}"
      when: ansible_facts.net_iostype  == "IOS-XE"
      
    - name: configurable backup path
      iosxr_config:
        backup: yes
        backup_options:
          filename: "{{ net_hostname }}"
          dir_path: "{{ config_folder }}/{{ net_model }}"
      when: ansible_facts.net_iostype  == "IOS-XR"
      
    - name: configurable backup path
      nxos_config:
        backup: yes
        backup_options:
          filename: "{{ net_hostname }}"
          dir_path: "{{ config_folder }}/{{ net_model }}"
      when: ansible_facts.net_iostype  == "NX-OS"
    
    - name: Add configs
      shell: "git add ."
      args:
        chdir: "{{ config_folder }}"
      register: gitadd
      
    - name: check differences
      shell: git diff HEAD
      args:
        chdir: "{{ config_folder }}"
      register: diffs

    - name: get time
      shell: TZ=Europe/Athens date '+%Y-%m-%d %H:%M:%S'
      register: timestamp
      when: diffs.stdout

    - name: Git commit
      shell: git commit -m "Ansible Managed Backup - {{ timestamp.stdout }}"
      args:
        chdir: "{{ config_folder }}"
      register: gitcommit
      when: diffs.stdout

    - name: Git push
      shell: git push origin master
      args:
        chdir: "{{ config_folder }}"
      when: diffs.stdout
      register: gitpush
